name: Rust

on:
  push:
    branches: [ trunk ]
  pull_request:
    branches: [ trunk ]

jobs:
  update-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - id: cargo-deps
        name: Cache dependency crates
        uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: cargo-deps-${{ hashFiles('Cargo.lock') }}

      - if: steps.cargo-deps.outputs.cache-hit != 'true'
        name: Fetch dependencies
        run: cargo fetch

  test:
    needs: update-deps
    runs-on: ubuntu-latest
    env:
      CARGO_INCREMENTAL: 0

    name: cargo test
      steps:
        - uses: actions/checkout@v2

        - name: Install deps
          run: |
            sudo apt-get update
            sudo apt-get install libasound2-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libpango1.0-dev libatk1.0-dev libgtk-3-dev

        - name: Restore dependency crates
          uses: actions/cache@v2
          with:
            path: |
              ~/.cargo/registry/index
              ~/.cargo/registry/cache
              ~/.cargo/git/db
            key: cargo-deps-${{ hashFiles('Cargo.lock') }}

        - name: Build
          run: cargo build --locked --verbose

        - name: Run tests
          run: cargo test --locked --verbose
